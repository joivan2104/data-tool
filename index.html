<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è³‡æ–™å»ºæª”ç³»çµ±ï¼ˆå«æ·¨é‡èˆ‡é–å®šé‚„åŸï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <!-- Firebase Analytics -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics-compat.js"></script>
  <!-- Firebase Database -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <style>
    html { font-size: 77.77%; }
    input[type="text"], input[type="number"], input[type="date"] {
      max-width: 40px !important;
      font-size: 0.75rem !important;
    }
    button { font-size: 0.80rem !important; }
    .max-w-6xl {
      max-width: 52rem !important;
      margin-left: 0 !important;
      margin-right: auto !important;
    }
    .form-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .form-column {
      min-width: 0;
    }
    .group-label {
      font-weight: bold;
      margin-right: 0.5rem;
    }
    .btn {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      color: white;
    }
    .btn-blue { background-color: #2563eb; }
    .btn-gray { background-color: #4b5563; }
    .btn-green { background-color: #16a34a; }
    .btn-red { background-color: #dc2626; }
    .btn-yellow { background-color: #eab308; color: black; }
  </style>
</head>
<body class="p-2 bg-gray-100">
  <div class="max-w-6xl text-xs">
    <h1 class="text-base font-bold mb-2">ğŸ“¦ è³‡æ–™å»ºæª”ç³»çµ±</h1>
    <div class="mb-2 flex flex-wrap gap-2">
      <button onclick="switchTab('form')" class="btn btn-blue">è¼¸å…¥è³‡æ–™</button>
      <button onclick="switchTab('output')" class="btn btn-gray">å·²å»ºç«‹è³‡æ–™</button>
      <button onclick="exportExcel()" class="btn btn-green">åŒ¯å‡º Excel</button>
      <button onclick="localStorage.clear(); location.reload()" class="btn btn-red">æ¸…é™¤å…¨éƒ¨</button>
      <button onclick="addFormBlock()" class="btn btn-yellow">æ–°å¢è¡¨å–®</button>
    </div>
    <div id="formTab">
      <div id="formContainer" class="form-columns">
        <div class="form-column space-y-4"></div>
        <div class="form-column space-y-4"></div>
      </div>
    </div>
    <div id="outputTab" class="hidden mt-4"><div id="output" class="space-y-4"></div></div>
  </div>
  <script>
    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyAYP7j1S7mts7g2QsGGWpFO1Ay-1VzBDHE",
      authDomain: "yongtai-96000.firebaseapp.com",
      databaseURL: "https://yongtai-96000-default-rtdb.firebaseio.com",
      projectId: "yongtai-96000",
      storageBucket: "yongtai-96000.firebasestorage.app",
      messagingSenderId: "528027278444",
      appId: "1:528027278444:web:8591ed6c3cef3b4f750c49",
      measurementId: "G-H5YP3JX4LE"
    };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const analytics = firebase.analytics();
    const database = firebase.database();

    let formId = 0;
    let groupCounters = {};

    function switchTab(tab) {
      document.getElementById('formTab').classList.toggle('hidden', tab !== 'form');
      document.getElementById('outputTab').classList.toggle('hidden', tab !== 'output');
    }

    function addFormBlock(data = null) {
      const formContainer = document.getElementById('formContainer');
      const columns = formContainer.querySelectorAll('.form-column');
      const currentFormId = formId++;
      
      // æ±ºå®šè¦å°‡è¡¨å–®åŠ å…¥å“ªä¸€æ¬„
      const targetColumn = columns[0].children.length <= columns[1].children.length ? columns[0] : columns[1];
      
      const formBlock = document.createElement('div');
      formBlock.className = 'border p-2 bg-white rounded space-y-1';
      formBlock.setAttribute('data-form-id', currentFormId);
      formBlock.innerHTML = `
        <div class="flex justify-between items-center">
          <div class="flex items-center gap-2">
            <span class="font-bold">è¡¨å–®ç¨±è™Ÿï¼š</span>
            <select class="form-title-select border text-xs p-0.5 rounded">
              <option value="è³‡æ–™è¡¨å–®" ${data?.ç¨±è™Ÿ === "è³‡æ–™è¡¨å–®" ? "selected" : ""}>è³‡æ–™è¡¨å–®</option>
              <option value="è¼¸é€ç´€éŒ„è¡¨å–®" ${data?.ç¨±è™Ÿ === "è¼¸é€ç´€éŒ„è¡¨å–®" ? "selected" : ""}>è¼¸é€ç´€éŒ„è¡¨å–®</option>
              <option value="åº«å­˜ç™»è¨˜è¡¨å–®" ${data?.ç¨±è™Ÿ === "åº«å­˜ç™»è¨˜è¡¨å–®" ? "selected" : ""}>åº«å­˜ç™»è¨˜è¡¨å–®</option>
              <option value="å·¥ä»¶è¿½è¹¤è¡¨å–®" ${data?.ç¨±è™Ÿ === "å·¥ä»¶è¿½è¹¤è¡¨å–®" ? "selected" : ""}>å·¥ä»¶è¿½è¹¤è¡¨å–®</option>
            </select>
          </div>
          <div class="flex gap-1">
            <button onclick="toggleDisable(this)" class="text-blue-500">ğŸ”’ é–å®š</button>
            <button onclick="toggleDisable(this, false)" class="text-green-500">ğŸ”“ è§£é–</button>
            <button onclick="this.closest('[data-form-id]').remove(); saveToLocal()" class="text-red-500">ğŸ—‘ åˆªé™¤æ­¤è¡¨å–®</button>
          </div>
        </div>
        <div class="flex flex-wrap gap-1">
          <input type="date" class="border p-0.5 text-xs" placeholder="æ—¥æœŸ" value="${data?.æ—¥æœŸ || ''}">
          <input type="text" class="border p-0.5 text-xs" placeholder="å®¢æˆ¶" value="${data?.å®¢æˆ¶ || ''}">
          <input type="text" class="border p-0.5 text-xs" placeholder="å“é …" value="${data?.å“é … || ''}">
        </div>
        <div class="space-y-2" id="groupArea-${currentFormId}"></div>
        <button onclick="addGroup(${currentFormId})" class="bg-blue-500 text-white px-2 py-0.5 rounded text-xs">â•æ–°å¢ç¾¤çµ„</button>
      `;
      targetColumn.appendChild(formBlock);
      if (data?.ç¾¤çµ„) data.ç¾¤çµ„.forEach(g => addGroup(currentFormId, g)); else addGroup(currentFormId);
      if (data?.disabled) setTimeout(() => formBlock.querySelectorAll('input').forEach(i => i.disabled = true), 0);
      saveToLocal();
    }

    function addGroup(formId, groupData = null) {
      const groupArea = document.getElementById(`groupArea-${formId}`);
      if (!groupCounters[formId]) groupCounters[formId] = 1;
      const currentGroupNumber = groupCounters[formId]++;
      const groupId = Date.now() + Math.floor(Math.random() * 1000);
      const groupBlock = document.createElement('div');
      groupBlock.className = 'border p-2 rounded bg-gray-50 space-y-1';
      groupBlock.setAttribute('data-group-id', groupId);
      groupBlock.setAttribute('data-group-number', currentGroupNumber);
      groupBlock.innerHTML = `
        <div class="flex justify-between items-center">
          <div><span class="group-label">ç¾¤çµ„ ${currentGroupNumber}</span></div>
          <button onclick="removeGroup(this, ${formId})" class="text-red-500">ğŸ—‘ åˆªé™¤æ­¤ç¾¤çµ„</button>
        </div>
        <div class="flex flex-wrap gap-1">
          <input type="number" class="border p-0.5 text-xs" placeholder="ä»¶æ•¸" value="${groupData?.ä»¶æ•¸ || ''}">
          <input type="number" class="border p-0.5 text-xs" placeholder="ç¸½é‡" value="${groupData?.ç¸½é‡ || ''}">
          <input type="number" class="border p-0.5 text-xs" placeholder="æ¿é‡" value="${groupData?.æ¿é‡ || ''}">
        </div>
        <div class="space-y-1 ml-4" id="sizeArea-${groupId}"></div>
        <button onclick="addSize(${groupId})" class="bg-green-600 text-white px-2 py-0.5 rounded text-xs ml-4">â•æ–°å¢å°ºå¯¸</button>
      `;
      groupArea.appendChild(groupBlock);
      if (groupData?.å°ºå¯¸) groupData.å°ºå¯¸.forEach(size => addSize(groupId, size));
      else addSize(groupId);
      if (groupData?.disabled) setTimeout(() => groupBlock.querySelectorAll('input').forEach(i => i.disabled = true), 0);
      updateGroupNumbers(formId);
      saveToLocal();
    }

    function addSize(groupId, sizeData = {}) {
      const sizeArea = document.getElementById(`sizeArea-${groupId}`);
      const div = document.createElement('div');
      div.className = 'flex flex-wrap gap-1 items-center';
      div.innerHTML = `
        <input type="number" class="border p-0.5 text-xs" placeholder="é•·" value="${sizeData?.é•· || ''}">
        <input type="number" class="border p-0.5 text-xs" placeholder="å¯¬" value="${sizeData?.å¯¬ || ''}">
        <input type="number" class="border p-0.5 text-xs" placeholder="é«˜" value="${sizeData?.é«˜ || ''}">
        <input type="number" class="border p-0.5 text-xs" placeholder="æ•¸é‡" value="${sizeData?.æ•¸é‡ || ''}">
        <button onclick="this.parentElement.remove(); saveToLocal()" class="text-red-400 px-2">âœ–</button>
      `;
      sizeArea.appendChild(div);
      if (sizeData?.disabled) setTimeout(() => div.querySelectorAll('input').forEach(i => i.disabled = true), 0);
      saveToLocal();
    }

    function toggleDisable(btn, lock = true) {
      const form = btn.closest('[data-form-id]');
      form.querySelectorAll('input').forEach(input => input.disabled = lock);
      saveToLocal();
    }

    function removeGroup(btn, formId) {
      btn.closest('[data-group-id]').remove();
      updateGroupNumbers(formId);
      saveToLocal();
    }

    function updateGroupNumbers(formId) {
      const area = document.getElementById(`groupArea-${formId}`);
      area.querySelectorAll('[data-group-id]').forEach((g, i) => {
        g.querySelector('.group-label').textContent = `ç¾¤çµ„ ${i + 1}`;
      });
      groupCounters[formId] = area.querySelectorAll('[data-group-id]').length + 1;
    }

    function gatherData(raw = false) {
      const all = document.querySelectorAll('[data-form-id]');
      const result = [];

      all.forEach(form => {
        const title = form.querySelector('.form-title-select').value;
        const date = form.querySelector('input[type="date"]').value;
        const customer = form.querySelector('input[placeholder="å®¢æˆ¶"]').value;
        const item = form.querySelector('input[placeholder="å“é …"]').value;
        const groups = form.querySelectorAll('[data-group-id]');
        const groupList = [];

        groups.forEach(group => {
          const quantity = group.querySelector('input[placeholder="ä»¶æ•¸"]').value;
          const weight = parseFloat(group.querySelector('input[placeholder="ç¸½é‡"]').value) || 0;
          const pallet = parseFloat(group.querySelector('input[placeholder="æ¿é‡"]').value) || 0;
          const net = Math.round(weight - pallet);
          const sizes = group.querySelectorAll(`#sizeArea-${group.dataset.groupId} > div`);
          const sizeList = [];

          sizes.forEach(row => {
            const l = row.querySelector('input[placeholder="é•·"]').value;
            const w = row.querySelector('input[placeholder="å¯¬"]').value;
            const h = row.querySelector('input[placeholder="é«˜"]').value;
            const c = row.querySelector('input[placeholder="æ•¸é‡"]').value;
            const cbm = ((l * w * h * c) / 1000000).toFixed(3);

            if (raw) sizeList.push({ é•·: l, å¯¬: w, é«˜: h, æ•¸é‡: c, disabled: row.querySelector('input')?.disabled || false });
            else result.push({ ç¨±è™Ÿ: title,æ—¥æœŸ: date, å®¢æˆ¶: customer, å“é …: item, ä»¶æ•¸: quantity, ç¸½é‡: weight, æ¿é‡: pallet, æ·¨é‡: net, é•·: l, å¯¬: w, é«˜: h, æ•¸é‡: c, æç©: cbm });
          });

          if (raw) groupList.push({ ä»¶æ•¸: quantity, ç¸½é‡: weight, æ¿é‡: pallet, disabled: group.querySelector('input')?.disabled || false, å°ºå¯¸: sizeList });
        });

        if (raw) result.push({ æ—¥æœŸ: date, å®¢æˆ¶: customer, å“é …: item, disabled: form.querySelector('input')?.disabled || false, ç¾¤çµ„: groupList });
      });

      return result;
    }

    function displayOutput() {
      const out = document.getElementById("output");
      out.innerHTML = "";
      const data = gatherData();

      if (!data.length) return out.textContent = "ç›®å‰ç„¡è³‡æ–™";

      const table = document.createElement("table");
      table.className = "table-auto border border-collapse w-full text-xs";
      table.innerHTML = `
        <thead><tr class="bg-gray-300">${Object.keys(data[0]).map(k => `<th class="border px-1">${k}</th>`).join('')}</tr></thead>
        <tbody>${data.map(r => `<tr>${Object.values(r).map(v => `<td class="border px-1">${v}</td>`).join('')}</tr>`).join('')}</tbody>
      `;
      out.appendChild(table);
    }

    function exportExcel() {
      const data = gatherData();
      if (!data.length) return alert("æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™ï¼");
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "è³‡æ–™è¡¨");
      XLSX.writeFile(wb, "è³‡æ–™å»ºæª”.xlsx");
    }

    function saveToLocal() {
      const data = gatherData(true);
      // åŒæ™‚ä¿å­˜åˆ° localStorage å’Œ Firebase
      localStorage.setItem("formData", JSON.stringify(data));
      database.ref('formData').set(data);
    }

    function restoreFromLocal() {
      // å…ˆå¾ Firebase è®€å–è³‡æ–™
      database.ref('formData').once('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          document.getElementById("formContainer").innerHTML = `
            <div class="form-column space-y-4"></div>
            <div class="form-column space-y-4"></div>
          `;
          data.forEach(f => addFormBlock(f));
        } else {
          // å¦‚æœ Firebase æ²’æœ‰è³‡æ–™ï¼Œå‰‡å¾ localStorage è®€å–
          const raw = localStorage.getItem("formData");
          if (!raw) return;
          const saved = JSON.parse(raw);
          document.getElementById("formContainer").innerHTML = `
            <div class="form-column space-y-4"></div>
            <div class="form-column space-y-4"></div>
          `;
          saved.forEach(f => addFormBlock(f));
        }
      });
    }

    // ç›£è½è³‡æ–™è®Šæ›´
    database.ref('formData').on('value', (snapshot) => {
      const data = snapshot.val();
      if (data) {
        document.getElementById("formContainer").innerHTML = `
          <div class="form-column space-y-4"></div>
          <div class="form-column space-y-4"></div>
        `;
        data.forEach(f => addFormBlock(f));
      }
    });

    document.querySelector('button.btn-gray').addEventListener("click", displayOutput);
    window.addEventListener("DOMContentLoaded", restoreFromLocal);
  </script>
</body>
</html>
