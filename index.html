<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è³‡æ–™å»ºæª”å·¥å…·</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; }
    input, button { margin: 6px 0; padding: 8px; width: 100%; box-sizing: border-box; font-size: 16px; }
    button {
      background-color: #007bff; color: white; border: none;
      border-radius: 4px; cursor: pointer; padding: 6px 12px;
      font-size: 14px; margin: 4px 4px 4px 0; width: auto;
    }
    button:hover { background-color: #0056b3; }
    label { display: block; margin-top: 12px; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 14px; }
    .delete-btn { background-color: #dc3545; }
    .edit-btn { background-color: #ffc107; color: black; }
    .summary { font-weight: bold; text-align: right; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ğŸ“‹ è³‡æ–™å»ºæª”å·¥å…·</h1>
  <button onclick="createGroup()">â• æ–°å¢ç¾¤çµ„</button>
  <div id="group-list" style="margin-top: 20px;"></div>
  <div id="entry-form" style="margin-top: 30px;"></div>

  <script>
    let groups = JSON.parse(localStorage.getItem("groups") || "[]");
    let currentGroup = null;
    let editingIndex = null;
    let lastName = "";

    function saveToStorage() {
      localStorage.setItem("groups", JSON.stringify(groups));
    }

    function createGroup() {
      const name = prompt("è¼¸å…¥ç¾¤çµ„åç¨±ï¼š");
      if (name && !groups.find(g => g.name === name)) {
        const newGroup = { name, entries: [] };
        groups.push(newGroup);
        currentGroup = newGroup;
        saveToStorage();
        renderGroups();
        renderForm();
      } else {
        alert("åç¨±å·²å­˜åœ¨æˆ–ç„¡æ•ˆ");
      }
    }

    function renderGroups() {
      const list = document.getElementById("group-list");
      list.innerHTML = "";
      groups.forEach(group => {
        const div = document.createElement("div");
        div.innerHTML = `
          <button onclick="selectGroup('${group.name}')">${group.name}</button>
          <button onclick="exportGroup('${group.name}')" style="background-color: #28a745;">åŒ¯å‡º Excel</button>
          <button onclick="deleteGroup('${group.name}')" style="background-color: #dc3545;">âŒ åˆªé™¤</button>
        `;
        list.appendChild(div);
      });
    }

    function selectGroup(name) {
      currentGroup = groups.find(g => g.name === name);
      editingIndex = null;
      renderForm();
    }

    function deleteGroup(name) {
      if (confirm(`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ç¾¤çµ„ï¼Ÿ`)) {
        groups = groups.filter(g => g.name !== name);
        currentGroup = null;
        saveToStorage();
        renderGroups();
        document.getElementById("entry-form").innerHTML = "";
      }
    }

    function renderForm() {
      const form = document.getElementById("entry-form");
      form.innerHTML = `<h2>${currentGroup.name} - ${editingIndex !== null ? "ç·¨è¼¯" : "æ–°å¢"}è³‡æ–™</h2>`;
      const today = new Date();
      const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
      const dateLabel = document.createElement("label");
      dateLabel.textContent = `æ—¥æœŸï¼š${dateStr}`;
      form.appendChild(dateLabel);

      const fields = ["åç¨±", "ç¸½é‡", "æ¿é‡", "ä»¶æ•¸", "é•·", "å¯¬", "é«˜", "å‚™è¨»"];
      fields.forEach(field => {
        const label = document.createElement("label");
        label.textContent = field + "ï¼š";
        const input = document.createElement("input");
        input.type = "text";
        input.id = field;
        input.placeholder = `è«‹è¼¸å…¥ ${field}`;
        input.required = true;
        form.appendChild(label);
        form.appendChild(input);
      });

      if (editingIndex !== null) {
        const entry = currentGroup.entries[editingIndex];
        fields.forEach(f => {
          document.getElementById(f).value = entry[f] || "";
        });
      } else {
        document.getElementById("åç¨±").value = lastName;
      }

      const button = document.createElement("button");
      button.textContent = editingIndex !== null ? "âœ” æ›´æ–°" : "ğŸ“Œ å»ºç«‹";
      button.onclick = editingIndex !== null ? updateEntry : handleSubmit;
      form.appendChild(button);

      renderTable();
    }

    function handleSubmit() {
      const today = new Date();
      const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
      const name = document.getElementById("åç¨±").value;
      if (!name) return alert("è«‹è¼¸å…¥åç¨±ï¼");
      const é•· = parseFloat(document.getElementById("é•·").value) || 0;
      const å¯¬ = parseFloat(document.getElementById("å¯¬").value) || 0;
      const é«˜ = parseFloat(document.getElementById("é«˜").value) || 0;
      const ç¸½é‡ = parseFloat(document.getElementById("ç¸½é‡").value) || 0;
      const æ¿é‡ = parseFloat(document.getElementById("æ¿é‡").value) || 0;
      const æ·¨é‡ = +(ç¸½é‡ - æ¿é‡).toFixed(4);
      const CBM = +((é•· * å¯¬ * é«˜) / 1000000).toFixed(4);
      lastName = name;

      const entry = {
        æ—¥æœŸ: dateStr, åç¨±: name, ç¸½é‡, æ¿é‡, æ·¨é‡,
        ä»¶æ•¸: document.getElementById("ä»¶æ•¸").value,
        é•·, å¯¬, é«˜,
        å‚™è¨»: document.getElementById("å‚™è¨»").value,
        CBM
      };
      currentGroup.entries.push(entry);
      saveToStorage();
      renderForm();
    }

    function updateEntry() {
      const name = document.getElementById("åç¨±").value;
      if (!name) return alert("è«‹è¼¸å…¥åç¨±ï¼");
      const é•· = parseFloat(document.getElementById("é•·").value) || 0;
      const å¯¬ = parseFloat(document.getElementById("å¯¬").value) || 0;
      const é«˜ = parseFloat(document.getElementById("é«˜").value) || 0;
      const ç¸½é‡ = parseFloat(document.getElementById("ç¸½é‡").value) || 0;
      const æ¿é‡ = parseFloat(document.getElementById("æ¿é‡").value) || 0;
      const æ·¨é‡ = +(ç¸½é‡ - æ¿é‡).toFixed(4);
      const CBM = +((é•· * å¯¬ * é«˜) / 1000000).toFixed(4);
      lastName = name;
      currentGroup.entries[editingIndex] = {
        ...currentGroup.entries[editingIndex],
        åç¨±: name,
        ç¸½é‡, æ¿é‡, æ·¨é‡,
        ä»¶æ•¸: document.getElementById("ä»¶æ•¸").value,
        é•·, å¯¬, é«˜,
        å‚™è¨»: document.getElementById("å‚™è¨»").value,
        CBM
      };
      editingIndex = null;
      saveToStorage();
      renderForm();
    }

    function deleteEntry(index) {
      if (confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ")) {
        currentGroup.entries.splice(index, 1);
        saveToStorage();
        renderForm();
      }
    }

    function editEntry(index) {
      editingIndex = index;
      renderForm();
    }

    function renderTable() {
      const form = document.getElementById("entry-form");
      if (currentGroup.entries.length === 0) return;
      const table = document.createElement("table");
      const headers = ["æ—¥æœŸ", "åç¨±", "ç¸½é‡", "æ¿é‡", "æ·¨é‡", "ä»¶æ•¸", "é•·", "å¯¬", "é«˜", "å‚™è¨»", "CBM", "æ“ä½œ"];
      const thead = document.createElement("thead");
      const trHead = document.createElement("tr");
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      table.appendChild(thead);
      const tbody = document.createElement("tbody");
      currentGroup.entries.forEach((entry, i) => {
        const tr = document.createElement("tr");
        headers.slice(0, -1).forEach(h => {
          const td = document.createElement("td");
          td.textContent = entry[h] || "";
          tr.appendChild(td);
        });
        const tdActions = document.createElement("td");
        const editBtn = document.createElement("button");
        editBtn.className = "edit-btn";
        editBtn.textContent = "ä¿®æ”¹";
        editBtn.onclick = () => editEntry(i);
        tdActions.appendChild(editBtn);
        const delBtn = document.createElement("button");
        delBtn.className = "delete-btn";
        delBtn.textContent = "åˆªé™¤";
        delBtn.onclick = () => deleteEntry(i);
        tdActions.appendChild(delBtn);
        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      form.appendChild(table);
      const summary = document.createElement("div");
      summary.className = "summary";
      const totalCBM = currentGroup.entries.reduce((sum, e) => sum + (e.CBM || 0), 0).toFixed(4);
      summary.textContent = `ğŸ“¦ CBM ç¸½åˆè¨ˆï¼š${totalCBM}`;
      form.appendChild(summary);
    }

    function exportGroup(name) {
      const group = groups.find(g => g.name === name);
      const ws = XLSX.utils.json_to_sheet(group.entries);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "è³‡æ–™");
      const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      const blob = new Blob([wbout], { type: "application/octet-stream" });
      saveAs(blob, `${name}.xlsx`);
    }

    renderGroups();
  </script>
</body>
</html>
