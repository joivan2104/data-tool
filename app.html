<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è³‡æ–™å»ºæª”å·¥å…·ï¼ˆé›²ç«¯åŒæ­¥ï¼‰</title>
  <script>
    const password = "123456";
    let userInput = prompt("è«‹è¼¸å…¥å¯†ç¢¼ï¼š");
    if (userInput !== password) {
      document.write("<h2 style='color:red;text-align:center;'>å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•é¡¯ç¤ºå…§å®¹ã€‚</h2>");
      throw new Error("å¯†ç¢¼éŒ¯èª¤");
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, button { margin: 6px 0; padding: 8px; width: 100%; box-sizing: border-box; font-size: 16px; }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 6px 12px;
      font-size: 14px;
      margin: 4px 4px 4px 0;
      width: auto;
    }
    button:hover { background-color: #0056b3; }
    label { display: block; margin-top: 12px; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 14px; }
    .delete-btn { background-color: #dc3545; }
    .edit-btn { background-color: #ffc107; color: black; }
    .print-btn { background-color: #6c757d; color: white; }
    .summary { font-weight: bold; text-align: right; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ğŸ“‹ è³‡æ–™å»ºæª”å·¥å…·ï¼ˆé›²ç«¯åŒæ­¥ï¼‰</h1>
  <button onclick="createGroup()">â• æ–°å¢è³‡æ–™åç¨±</button>
  <button onclick="loadCloudData()" style="margin-left:10px; background-color:#28a745">â˜ï¸ å¾é›²ç«¯è¼‰å…¥</button>
  <div id="group-list" style="margin-top: 20px;"></div>
  <div id="entry-form" style="margin-top: 30px;"></div>
  <script>
    const webhookURL = "https://script.google.com/macros/s/AKfycbwijAEDzKUEbbt5HxOhCM-dKbDputSfpfgCnmuIVreZ38dY2WAdJ7EvnTcUhLS01vi5/exec";
    let groups = JSON.parse(localStorage.getItem("groups") || "[]");
    let currentGroup = null;
    let lastName = "";
    let editingIndex = null;

    function saveToStorage() {
      localStorage.setItem("groups", JSON.stringify(groups));
    }

    async function saveToCloud(groupName, entry) {
      try {
        await fetch(webhookURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ group: groupName, ...entry })
        });
      } catch (err) {
        console.error("é›²ç«¯å„²å­˜å¤±æ•—", err);
      }
    }

    async function loadCloudData() {
      try {
        const res = await fetch(webhookURL);
        const data = await res.json();
        if (Array.isArray(data)) {
          const map = {};
          data.forEach(item => {
            if (!map[item.group]) map[item.group] = [];
            map[item.group].push(item);
          });
          groups = Object.entries(map).map(([name, entries]) => ({ name, entries }));
          saveToStorage();
         function createGroup() {
    const name = prompt("è¼¸å…¥è³‡æ–™åç¨±ï¼š");
    if (name && !groups.find(g => g.name === name)) {
      const newGroup = { name, entries: [] };
      groups.push(newGroup);
      currentGroup = newGroup; // è¨­å®šç›®å‰ç·¨è¼¯çš„ç¾¤çµ„
      saveToStorage();
      renderGroups();
      renderForm(); // é¡¯ç¤ºè©²ç¾¤çµ„çš„è¼¸å…¥æ¬„ä½
    } else {
      alert("è³‡æ–™åç¨±å·²å­˜åœ¨æˆ–è¼¸å…¥ç„¡æ•ˆ");
    }
  }

  function renderGroups() {
    const list = document.getElementById("group-list");
    list.innerHTML = "";
    groups.forEach(group => {
      const div = document.createElement("div");
      div.innerHTML = `
        <button onclick="selectGroup('${group.name}')">${group.name}</button>
        <button onclick="exportGroup('${group.name}')" style="background-color: #28a745; margin-left: 5px;">åŒ¯å‡º Excel</button>
        <button onclick="printGroup('${group.name}')" class="print-btn" style="margin-left: 5px;">ğŸ–¨ åˆ—å°</button>
        <button onclick="deleteGroup('${group.name}')" style="background-color: #dc3545; margin-left: 5px;">âŒ åˆªé™¤</button>
      `;
      list.appendChild(div);
    });
  }

  function selectGroup(name) {
    currentGroup = groups.find(g => g.name === name);
    editingIndex = null;
    renderForm();
  }

  // ä½ çš„åŸå§‹ç¨‹å¼ç¢¼ä¸­ renderForm, deleteGroup, exportGroup ç­‰å‡½å¼ä¿æŒä¸è®Š
  // å·²å…§å»ºçš„ renderGroups(); ä¹Ÿä¿ç•™å³å¯
</script>
    renderGroups();
    renderForm(); // âœ… é¡¯ç¤ºè¡¨å–®ç•«é¢
  } else {
    alert("è³‡æ–™åç¨±å·²å­˜åœ¨æˆ–ç„¡æ•ˆ");
  }
}
          renderGroups();
          alert("âœ… é›²ç«¯è³‡æ–™å·²è¼‰å…¥ï¼");
        }
      } catch (err) {
        alert("âš ï¸ é›²ç«¯è³‡æ–™è®€å–å¤±æ•—");
        console.error(err);
      }
    }

    // createGroup / deleteGroup / renderGroups èˆ‡åŸé‚è¼¯ç›¸åŒ
    // selectGroup / renderForm / handleSubmit / updateEntry / deleteEntry / editEntry / renderTable / exportGroup / printGroup
    // æ­¤è™•ç•¥ï¼Œèˆ‡ä½ åŸå§‹æª”æ¡ˆå…§å®¹ä¸€è‡´ï¼Œåƒ…åœ¨ handleSubmit å’Œ updateEntry å¢åŠ  saveToCloud()

    // EXAMPLEï¼šåŠ å…¥é›²ç«¯å„²å­˜å‘¼å«
    function handleSubmit() {
      const today = new Date();
      const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
      const name = document.getElementById("åç¨±").value;
      if (!name) return alert("è«‹è¼¸å…¥åç¨±ï¼");
      const é•· = parseFloat(document.getElementById("é•·").value) || 0;
      const å¯¬ = parseFloat(document.getElementById("å¯¬").value) || 0;
      const é«˜ = parseFloat(document.getElementById("é«˜").value) || 0;
      const ç¸½é‡ = parseFloat(document.getElementById("ç¸½é‡").value) || 0;
      const æ¿é‡ = parseFloat(document.getElementById("æ¿é‡").value) || 0;
      const æ·¨é‡ = +(ç¸½é‡ - æ¿é‡).toFixed(4);
      const CBM = +((é•· * å¯¬ * é«˜) / 1000000).toFixed(4);
      lastName = name;
      const entry = {
        æ—¥æœŸ: dateStr, åç¨±: name, ç¸½é‡, æ¿é‡, æ·¨é‡,
        ä»¶æ•¸: document.getElementById("ä»¶æ•¸").value,
        é•·, å¯¬, é«˜, å‚™è¨»: document.getElementById("å‚™è¨»").value, CBM
      };
      currentGroup.entries.push(entry);
      saveToStorage();
      saveToCloud(currentGroup.name, entry);
      renderForm();
    }

    // å…¶é¤˜åŸå§‹åŠŸèƒ½è«‹åƒç…§ä½ ä¸Šå‚³çš„ HTML ä¸­ç¨‹å¼ç¢¼æ•´åˆå³å¯

    renderGroups();
  </script>
</body>
</html>
